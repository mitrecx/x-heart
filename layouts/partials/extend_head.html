<script>
// 轻量级命令行着色增强：仅处理未被 Chroma 精细标注的行，也补充首词命令名高亮
(function() {
  function wrapFirstCommandWord(line) {
    var PREFIX = /^(sudo|doas|time|command|nice|ionice|env)$/;
    // 小工具：收集行内的所有纯文本节点
    function collectTextNodes(root, out) {
      out = out || [];
      root.childNodes.forEach(function(n){
        if (n.nodeType === 3) out.push(n);
        else collectTextNodes(n, out);
      });
      return out;
    }
    // 小工具：根据整体偏移找到具体文本节点与内部偏移
    function locateByOffset(root, offset) {
      var nodes = collectTextNodes(root);
      var acc = 0;
      for (var i=0;i<nodes.length;i++) {
        var t = nodes[i];
        var len = t.nodeValue.length;
        if (offset <= acc + len) {
          return { node: t, inner: offset - acc };
        }
        acc += len;
      }
      return null;
    }

    // 先尝试：如果行首是命令或前缀，则高亮（兼容已有做法）
    var node = line.firstChild;
    var highlightedFirst = false;
    var needNextCmd = false;
    while (node) {
      if (node.nodeType === 3) { // 文本节点
        var txt = node.nodeValue;
        var mSpace = txt.match(/^(\s*)/);
        var leading = mSpace ? mSpace[0] : '';
        var rest = txt.slice(leading.length);
        if (rest.length === 0) { node = node.nextSibling; continue; }
        var mWord = rest.match(/^([A-Za-z0-9._-]+)/);
        if (mWord) {
          var cmd = mWord[1];
          var after = rest.slice(cmd.length);
          var frag = document.createDocumentFragment();
          if (leading) frag.appendChild(document.createTextNode(leading));
          var span = document.createElement('span');
          span.className = highlightedFirst ? 'tk-cmd' : (PREFIX.test(cmd) ? 'tk-prefix' : 'tk-cmd');
          span.textContent = cmd;
          frag.appendChild(span);
          if (after) frag.appendChild(document.createTextNode(after));
          var next = node.nextSibling;
          line.replaceChild(frag, node);
          highlightedFirst = true;
          if (PREFIX.test(cmd) && !needNextCmd) { needNextCmd = true; node = line.firstChild; continue; }
          if (needNextCmd) { break; }
          node = next;
          continue;
        }
      }
      node = node.nextSibling;
    }

    // 补充：如果包含 `! cmd` 结构，则用 Range 包裹 cmd
    try {
      var raw = line.textContent;
      var bang = raw.match(/!\s*([A-Za-z0-9._-]+)/);
      if (bang) {
        var word = bang[1];
        var idxBang = raw.indexOf(bang[0]);
        var idxWord = raw.indexOf(word, idxBang);
        if (idxWord >= 0) {
          var startLoc = locateByOffset(line, idxWord);
          var endLoc = locateByOffset(line, idxWord + word.length);
          if (startLoc && endLoc) {
            var range = document.createRange();
            range.setStart(startLoc.node, startLoc.inner);
            range.setEnd(endLoc.node, endLoc.inner);
            var wrap = document.createElement('span');
            wrap.className = 'tk-cmd';
            range.surroundContents(wrap);
          }
        }
      }
    } catch(e) { /* 忽略失败，保持原样 */ }
  }

  function enhanceShellBlocks() {
    var blocks = document.querySelectorAll('code.language-bash, code.language-sh');
    var PREFIX = /^(sudo|doas|time|command|nice|ionice|env)$/;
    blocks.forEach(function(code) {
      var lines = code.querySelectorAll('.line .cl');
      lines.forEach(function(line) {
        var raw = line.textContent;
        if (!raw || !raw.trim()) return;
        // 跳过注释行
        if (raw.trim().startsWith('#')) return;
        if (line.querySelector('span:not(.cl)')) {
          // 已有部分token：为首个命令词（及sudo等前缀后的下一个命令）补充高亮
          wrapFirstCommandWord(line);
          return;
        }
        // 否则进行完整的切分高亮
        var parts = raw.split(/(\s+)/);
        var frag = document.createDocumentFragment();
        var expectCmd = true; // 行首或管道/与/或 之后的第一个词视为命令名
        parts.forEach(function(part) {
          if (!part) return;
          if (/^\s+$/.test(part)) { frag.appendChild(document.createTextNode(part)); return; }
          var span = document.createElement('span');
          // 操作符
          if (/^(\|\||\||&&|>>?|<<?)$/.test(part)) { span.className = 'tk-op'; expectCmd = true; }
          // 前缀命令（sudo 等），同时让下一个词也按命令处理
          else if (PREFIX.test(part)) { span.className = 'tk-prefix'; expectCmd = true; }
          // 命令名（行首或操作符/前缀后）
          else if (expectCmd) { span.className = 'tk-cmd'; expectCmd = false; }
          // 选项（-t, --long）
          else if (/^[-]{1,2}[A-Za-z0-9][A-Za-z0-9-]*$/.test(part)) { span.className = 'tk-opt'; }
          // 路径
          else if (/^\//.test(part)) { span.className = 'tk-path'; }
          // IP:PORT
          else if (/^\d{1,3}(?:\.\d{1,3}){3}(?::\d+)?$/.test(part)) { span.className = 'tk-ip'; }
          // 数字/纯数值
          else if (/^\d+(?:\.\d+)?$/.test(part)) { span.className = 'tk-num'; }
          span.textContent = part;
          frag.appendChild(span);
        });
        line.textContent = '';
        line.appendChild(frag);
      });
    });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', enhanceShellBlocks);
  } else {
    enhanceShellBlocks();
  }
})();
</script>

<style>
/* 重置并清理代码块样式 - 主题适配 */

/* 彻底重置所有代码块相关的背景和边框 */
.post-content .highlight:not(table),
.post-content .highlight,
.post-content pre,
.post-content pre code,
.chroma,
div.highlight {
    background: none !important;
    border: none !important;
    margin: 0 !important;
    padding: 0 !important;
    border-radius: 0 !important;
}

/* 定义主题变量 */
:root {
    --code-bg-custom: #f8f9fa;
    --code-text-custom: #24292e;
    --code-border-custom: #e1e4e8;
    --code-comment: #6b7280; /* 更清晰的注释灰 */
    --code-keyword: #ff79c6; /* 鲜艳粉 - 关键字 */
    --code-string: #22c55e; /* 亮绿 - 字符串 */
    --code-function: #0ea5e9; /* 青蓝 - 函数/方法 */
    --code-number: #8b5cf6; /* 紫色 - 数字 */
    --code-builtin: #f59e0b; /* 橙色 - 内建/命令 */
}

.dark {
    --code-bg-custom: #0d1117;
    --code-text-custom: #e6edf3;
    --code-border-custom: #30363d;
    --code-comment: #8b95a5; /* 暗色注释灰 */
    --code-keyword: #ff79c6; /* 粉 */
    --code-string: #50fa7b; /* 绿 */
    --code-function: #8be9fd; /* 青 */
    --code-number: #bd93f9; /* 紫 */
    --code-builtin: #ffa657; /* 橙 */
}

/* 仅为最外层的highlight div设置样式 */
.post-content div.highlight {
    background: var(--code-bg-custom) !important;
    color: var(--code-text-custom) !important;
    border: 1px solid var(--code-border-custom) !important;
    border-radius: 8px !important;
    padding: 16px !important;
    margin: 1.5em 0 !important;
    overflow-x: auto !important;
    position: relative !important;
}

/* 确保内部pre和code无额外样式 */
.post-content div.highlight pre,
.post-content div.highlight pre code {
    background: transparent !important;
    color: inherit !important;
    border: none !important;
    margin: 0 !important;
    padding: 0 !important;
    border-radius: 0 !important;
    display: block !important;
}

/* 内联代码样式 */
.post-content code:not(.chroma code):not(pre code) {
    background: var(--code-bg) !important;
    color: var(--content) !important;
    padding: 2px 6px !important;
    border-radius: 4px !important;
    font-size: 0.9em !important;
    border: 1px solid var(--border) !important;
    font-family: 'SF Mono', Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace !important;
}

/* 语法高亮颜色 */
.chroma .c, .chroma .c1, .chroma .cm, .chroma .cs {
    color: var(--code-comment) !important;
    font-style: italic !important;
}

.chroma .k, .chroma .kd, .chroma .kn, .chroma .kp, .chroma .kr, .chroma .kt {
    color: var(--code-keyword) !important;
    font-weight: bold !important;
}

.chroma .s, .chroma .s1, .chroma .s2, .chroma .sb, .chroma .sc, 
.chroma .sd, .chroma .se, .chroma .sh, .chroma .si, .chroma .sx {
    color: var(--code-string) !important;
}

.chroma .nf, .chroma .fm {
    color: var(--code-function) !important;
    font-weight: bold !important;
}

.chroma .m, .chroma .mb, .chroma .mf, .chroma .mh, .chroma .mi, .chroma .mo {
    color: var(--code-number) !important;
}

.chroma .nb, .chroma .bp {
    color: var(--code-builtin) !important;
}

/* 确保所有其他chroma元素继承正确的颜色 */
.chroma * {
    background: transparent !important;
}

/* 复制按钮样式 */
.copy-code {
    background: rgba(0, 0, 0, 0.7) !important;
    color: white !important;
    font-size: 12px !important;
    padding: 4px 8px !important;
    border-radius: 4px !important;
}

.dark .copy-code {
    background: rgba(255, 255, 255, 0.8) !important;
    color: black !important;
}

/* 确保没有其他元素干扰 */
.highlight pre.chroma {
    background: transparent !important;
}

/* 宽屏显示器优化样式 */
/* 超宽屏显示器上的内容宽度优化 */
@media screen and (min-width: 1600px) {
    .main {
        max-width: calc(1300px + 48px) !important;
    }
    
    .nav {
        max-width: calc(1300px + 48px) !important;
    }
    
    /* 文章内容区域优化 */
    .post-content-container {
        gap: 3rem !important;
    }
    
    .toc-sidebar {
        flex: 0 0 280px !important;
    }
}

@media screen and (min-width: 1920px) {
    .main {
        max-width: calc(1500px + 48px) !important;
    }
    
    .nav {
        max-width: calc(1500px + 48px) !important;
    }
    
    .post-content-container {
        gap: 4rem !important;
    }
    
    .toc-sidebar {
        flex: 0 0 300px !important;
    }
}

@media screen and (min-width: 2560px) {
    .main {
        max-width: calc(1700px + 48px) !important;
    }
    
    .nav {
        max-width: calc(1700px + 48px) !important;
    }
    
    .post-content-container {
        gap: 5rem !important;
    }
    
    .toc-sidebar {
        flex: 0 0 320px !important;
    }
}

/* 确保在超宽屏上内容不会过于拉伸 */
@media screen and (min-width: 1600px) {
    .post-content {
        max-width: 100% !important;
        line-height: 1.8 !important;
    }
    
    .post-content p {
        max-width: 100% !important;
    }
}

/* 优化宽屏上的图片显示 */
@media screen and (min-width: 1600px) {
    .post-content img {
        max-width: 100% !important;
        height: auto !important;
    }
    
    .post-content figure {
        max-width: 100% !important;
    }
}

/* 语法增强：让通用名称在多数语言（含bash）中更有颜色 */
.chroma .n,
.chroma .nx {
    color: #1f6feb !important; /* 蓝色：命名/标识符 */
}

.chroma .nb {
    color: #2da44e !important; /* 绿色：内建/常用命令 */
}

.chroma .o,
.chroma .ow {
    color: #d29922 !important; /* 操作符/关键字操作词：琥珀色 */
    font-weight: 600 !important;
}

/* 让数字更明显 */
.chroma .m,
.chroma .mi,
.chroma .mo,
.chroma .mf,
.chroma .il {
    color: #bc8cff !important; /* 淡紫色：数字 */
}

/* 将代码块角标改为显示语言（从 code 的 data-lang 读取） */
.post-content pre {
    position: relative !important;
}

.post-content pre > code::before {
    content: attr(data-lang) !important;
    position: absolute !important;
    top: -10px !important;
    right: 12px !important;
    background: #0366d6 !important;
    color: #fff !important;
    padding: 2px 8px !important;
    border-radius: 4px !important;
    font-size: 12px !important;
    font-weight: 600 !important;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
}

.dark .post-content pre > code::before {
    background: #58a6ff !important;
    color: #0d1117 !important;
}

/* 覆盖之前的“代码块”角标（如果存在） */
.post-content pre::before { content: none !important; }

/* 更鲜艳的语法高亮覆盖 */
.chroma .k, .chroma .kc, .chroma .kd, .chroma .kn, .chroma .kp, .chroma .kr, .chroma .kt {
    color: var(--code-keyword) !important;
    font-weight: 700 !important;
}

.chroma .s, .chroma .s1, .chroma .s2, .chroma .sb, .chroma .sc,
.chroma .sd, .chroma .se, .chroma .sh, .chroma .si, .chroma .sx, .chroma .sr, .chroma .ss {
    color: var(--code-string) !important;
}

.chroma .nf, .chroma .fm, .chroma .na {
    color: var(--code-function) !important;
}

.chroma .m, .chroma .mb, .chroma .mf, .chroma .mh, .chroma .mi, .chroma .il, .chroma .mo {
    color: var(--code-number) !important;
}

.chroma .nb, .chroma .bp, .chroma .nt, .chroma .nn, .chroma .no,
.chroma .nd, .chroma .ne, .chroma .nv, .chroma .vc, .chroma .vg, .chroma .vi, .chroma .vm, .chroma .py {
    color: var(--code-builtin) !important;
}

/* 操作符/标点稍作强调，辅以粉系 */
.chroma .o, .chroma .ow, .chroma .p {
    color: #f472b6 !important;
}

/* 注释稍加强对比 */
.chroma .c, .chroma .ch, .chroma .cm, .chroma .c1, .chroma .cs, .chroma .cp, .chroma .cpf {
    color: var(--code-comment) !important;
    font-style: italic !important;
}

/* 隐藏代码块语言角标 */
.post-content pre > code::before {
    content: none !important;
    display: none !important;
}

/* 进一步增强纯命令（bash/shell）的配色 */
/* 变量（$var、位置参数等）——亮黄 */
.chroma .nv, .chroma .vc, .chroma .vg, .chroma .vi, .chroma .vm {
    color: #eab308 !important;
    font-weight: 700 !important;
}

/* 选项/属性名（很多 lexer 会把 --long-option/-o 识别到 .na/.nd）——淡紫 */
.chroma .na, .chroma .nd {
    color: #a78bfa !important;
}

/* 内置命令/关键命令（echo, cd 等）——橙色已设，提升权重 */
.chroma .nb, .chroma .bp {
    color: var(--code-builtin) !important;
    font-weight: 700 !important;
}

/* 可能被归到普通名称（外部命令如 du/sort/head/find）——亮蓝 */
.chroma .n, .chroma .nx, .chroma .nn, .chroma .nt {
    color: #1f6feb !important;
}

/* 管道/重定向/操作符——玫红并加粗 */
.chroma .o, .chroma .ow, .chroma .p {
    color: #f472b6 !important;
    font-weight: 700 !important;
}
</style>

<style>
/* 轻量级命令行着色增强 - 颜色定义 */
.tk-cmd { color: #1f6feb !important; font-weight: 700 !important; }
.tk-prefix { color: #0ea5e9 !important; font-weight: 700 !important; }
.tk-opt { color: #a78bfa !important; }
.tk-path { color: #10b981 !important; }
.tk-op { color: #f43f5e !important; font-weight: 700 !important; }
.tk-num, .tk-ip { color: #8b5cf6 !important; }
</style>

<style>
/* 紧凑代码块左右内边距（略微左移） */
.post-content div.highlight { padding: 12px 14px 12px 10px !important; }
/* 确保pre本身无额外左侧空隙 */
.post-content div.highlight pre,
.post-content div.highlight pre code { margin-left: 0 !important; }
</style>

<style>
/* 调整列表项间距 - 减小上下间距 */
.post-content ol,
.post-content ul {
    margin-top: 0em !important;
    margin-left: 0.8em !important;
    margin-bottom: 1.5em !important;
}

.post-content li {
    margin-top: 2px !important;
    margin-bottom: 10px !important;
    line-height: 0.8 !important;
    padding: 8px 0 !important;
}

/* 确保列表和上方文本之间有适当间距 */
.post-content p + ol,
.post-content p + ul {
    margin-top: 0em !important;
}

/* 增加表格列间距和行间距 */
.post-content table td {
    padding: 5px 80px 5px 30px !important;
    line-height: 1.6 !important;
    white-space: nowrap !important;
}

.post-content table th {
    padding: 10px 30px 10px 30px !important;
    line-height: 1.6 !important;
    white-space: nowrap !important;
}

/* 增加表格整体间距 */
.post-content table {
    margin: 0.2em 0 1.6em 0 !important;
    border-spacing: 25px 8px !important;
}
</style>

<!-- 目录自动聚焦脚本 -->
<script>
(function() {
    function initTocAutoFocus() {
        // 获取所有标题元素
        const headings = document.querySelectorAll('.post-content h1, .post-content h2, .post-content h3, .post-content h4, .post-content h5, .post-content h6');
        const tocLinks = document.querySelectorAll('.toc a');
        
        if (headings.length === 0 || tocLinks.length === 0) return;
        
        // 清除所有高亮
        function clearHighlights() {
            tocLinks.forEach(link => {
                link.style.backgroundColor = '';
                link.style.color = '';
                link.style.padding = '';
                link.style.borderRadius = '';
            });
        }
        
        // 高亮指定索引的链接
        function highlightLink(index) {
            clearHighlights();
            if (tocLinks[index]) {
                tocLinks[index].style.backgroundColor = '#0366d6';
                tocLinks[index].style.color = 'white';
                tocLinks[index].style.padding = '2px 6px';
                tocLinks[index].style.borderRadius = '4px';
                
                // 自动滚动目录以显示高亮的链接
                scrollToTocLink(tocLinks[index]);
            }
        }
        
        // 目录自动滚动到指定链接
        function scrollToTocLink(link) {
            // 查找可滚动的容器
            const possibleContainers = [
                link.closest('.toc'),
                link.closest('.toc-sidebar'),
                link.closest('.inner'),
                link.closest('aside'),
                link.parentElement
            ];
            
            let tocContainer = null;
            for (const container of possibleContainers) {
                if (container && container.scrollHeight > container.clientHeight) {
                    const style = window.getComputedStyle(container);
                    if (style.overflow === 'auto' || style.overflow === 'scroll' || 
                        style.overflowY === 'auto' || style.overflowY === 'scroll') {
                        tocContainer = container;
                        break;
                    }
                }
            }
            
            if (!tocContainer) return;
            
            const linkRect = link.getBoundingClientRect();
            const containerRect = tocContainer.getBoundingClientRect();
            
            // 计算链接在容器中的相对位置
            const linkTop = linkRect.top - containerRect.top + tocContainer.scrollTop;
            const linkBottom = linkTop + linkRect.height;
            const containerHeight = containerRect.height;
            
            // 计算目标滚动位置
            let targetScrollTop = tocContainer.scrollTop;
            
            if (linkTop < tocContainer.scrollTop + 20) {
                // 链接在可视区域顶部上方，向上滚动
                targetScrollTop = Math.max(0, linkTop - 20);
            } else if (linkBottom > tocContainer.scrollTop + containerHeight - 20) {
                // 链接在可视区域底部下方，向下滚动
                targetScrollTop = Math.min(tocContainer.scrollHeight - containerHeight, linkBottom - containerHeight + 20);
            }
            
            // 执行滚动
            if (Math.abs(targetScrollTop - tocContainer.scrollTop) > 5) {
                tocContainer.scrollTop = targetScrollTop;
            }
        }
        
        // 滚动检测函数
        function checkScroll() {
            const scrollPosition = window.scrollY + 100;
            
            // 找到当前最接近的标题
            let currentIndex = -1;
            let closestDistance = Infinity;
            
            headings.forEach((heading, index) => {
                const headingTop = heading.offsetTop;
                const distance = Math.abs(scrollPosition - headingTop);
                
                if (distance < closestDistance && scrollPosition >= headingTop) {
                    closestDistance = distance;
                    currentIndex = index;
                }
            });
            
            // 如果没有找到，高亮第一个
            if (currentIndex === -1 && headings.length > 0) {
                currentIndex = 0;
            }
            
            if (currentIndex >= 0) {
                highlightLink(currentIndex);
            }
        }
        
        // 节流函数
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }
        
        // 监听滚动事件
        window.addEventListener('scroll', throttle(checkScroll, 150));
        
        // 初始化时检查一次
        checkScroll();
        
        // 处理点击事件
        tocLinks.forEach((link, index) => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                const targetElement = document.getElementById(targetId);
                
                if (targetElement) {
                    targetElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
    }
    
    // 等待DOM完全加载
    if (document.readyState === 'complete') {
        setTimeout(initTocAutoFocus, 500);
    } else {
        window.addEventListener('load', () => {
            setTimeout(initTocAutoFocus, 500);
        });
    }
})();
</script>

